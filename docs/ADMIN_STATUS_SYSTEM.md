# 행정 상태 시스템 문서

## 개요

짤막 서비스의 행정 상태 시스템은 게시글이 행정기관에 전달되어 처리되는 과정을 추적하고 관리하는 시스템입니다.

## 상태 종류

게시글은 다음 4가지 행정 상태를 가질 수 있습니다:

1. **`pending` (검토 대기 중)**
   - 기본값: 모든 새 게시글은 이 상태로 시작
   - 의미: 아직 행정기관에 전달되지 않았거나 검토 중인 상태

2. **`in_progress` (행정 처리 중)**
   - 의미: 행정기관에서 검토를 시작하여 처리 중인 상태

3. **`completed` (처리 완료)**
   - 의미: 행정기관에서 처리 완료된 상태

4. **`rejected` (반려됨)**
   - 의미: 행정 신고가 반려되거나 처리 불가능한 상태

## 데이터베이스 스키마

### Posts 테이블

```typescript
adminStatus: adminStatusEnum("adminStatus").default("pending"),
adminNotes: text("adminNotes"), // 관리자 메모 (선택사항)
```

## 자동 변경 로직

### 공감 50개 달성 시

- **자동 상태 변경**: 없음
- **알림 전송**:
  - 게시글 작성자에게 알림: "공감 임계치 도달"
  - 관리자에게 알림: "공감 임계치 도달 - 행정 신고 검토 필요"
- **목적**: 관리자가 수동으로 검토하고 상태를 변경하도록 안내

**구현 위치**: `server/routers.ts` - `posts.toggleEmpathy` mutation

## 수동 변경 방법

### API 엔드포인트

**경로**: `admin.updatePostStatus`

**권한**: 관리자(`role === "admin"`)만 사용 가능

**입력**:
```typescript
{
  postId: number,
  status: "pending" | "in_progress" | "completed" | "rejected",
  notes?: string  // 관리자 메모 (선택사항)
}
```

**동작**:
1. 게시글의 `adminStatus` 업데이트
2. `adminNotes` 업데이트 (제공된 경우)
3. 관리자 로그 기록 (`adminLogs` 테이블)
4. 게시글 작성자에게 알림 전송

**구현 위치**: `server/routers.ts` - `admin.updatePostStatus` mutation

## 알림 시스템

### 상태 변경 알림

게시글 상태가 변경되면 작성자에게 자동으로 알림이 전송됩니다:

- **타입**: `post_status_changed`
- **제목**: "게시글 상태 변경"
- **내용**: `"당신의 게시글이 "{상태명}" 상태로 변경되었습니다."`

### 공감 임계치 달성 알림

공감 50개 달성 시:

- **작성자 알림**:
  - 타입: `empathy_threshold_reached`
  - 제목: "공감 임계치 도달"
  - 내용: "당신의 게시글이 50명의 공감을 받았습니다! 행정 신고로 전달될 준비가 되었습니다."

- **관리자 알림**:
  - 타입: `empathy_threshold_reached`
  - 제목: "공감 임계치 도달 - 행정 신고 검토 필요"
  - 내용: 게시글 정보 포함

## UI 표시

### 현재 구현

- **홈 화면**: 모든 상태 배지 표시 (검토대기는 작은 배지, 나머지는 큰 배지)
- **지도 화면**: 모든 상태 배지 표시
- **게시글 상세**: 
  - 검토대기: 상단 작은 배지만 표시
  - 나머지 상태: 상단 배지 + 중간 큰 박스 표시
- **마이페이지**: 모든 상태 표시

### 상태별 스타일

- **검토대기**: 작은 회색 배지
- **처리중**: 파란색 배지 + 로딩 아이콘
- **처리 완료**: 초록색 배지 + 체크 아이콘
- **반려됨**: 빨간색 배지 + X 아이콘

## 관리자 기능 (향후 개발)

### 필요한 기능

1. **관리자 대시보드**
   - 공감 50개 달성 게시글 목록
   - 상태별 게시글 필터링
   - 검토 대기 중인 게시글 우선 표시

2. **게시글 상세 관리 UI**
   - 상태 변경 드롭다운
   - 관리자 메모 입력 필드
   - 상태 변경 이력 보기

3. **일괄 처리 기능**
   - 여러 게시글 선택하여 일괄 상태 변경
   - 필터링된 게시글 일괄 처리

4. **통계 및 리포트**
   - 상태별 게시글 통계
   - 처리 시간 추적
   - 지역별 처리 현황

## 데이터베이스 함수

### `updatePostAdminStatus`

**위치**: `server/db.ts`

**기능**: 게시글의 행정 상태와 메모를 업데이트

```typescript
updatePostAdminStatus(postId: number, status: string, notes?: string)
```

## 관련 파일

- **스키마**: `drizzle/schema.ts`
- **API 라우터**: `server/routers.ts`
- **데이터베이스 함수**: `server/db.ts`
- **알림 시스템**: `server/_core/notification.ts`

## 향후 개선 사항

1. **자동 상태 변경 옵션**
   - 공감 50개 달성 시 자동으로 `in_progress`로 변경하는 옵션
   - 설정 가능한 임계치

2. **상태 변경 워크플로우**
   - 상태 전환 규칙 정의 (예: `pending` → `in_progress` → `completed`)
   - 상태별 필수 메모 요구사항

3. **외부 시스템 연동**
   - 행정기관 API 연동
   - 자동 상태 동기화

4. **알림 개선**
   - 이메일 알림 옵션
   - 푸시 알림
   - 알림 템플릿 커스터마이징

